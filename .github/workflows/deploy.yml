name: Deploy to Firebase

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install Firebase CLI
      run: npm install -g firebase-tools@latest
    
    - name: Verify Firebase config
      run: |
        if [ -f "firebase.json" ]; then
          echo "âœ… Firebase config found"
          cat firebase.json
        else
          echo "âŒ Firebase config missing"
          exit 1
        fi
    
    - name: Deploy to Firebase Hosting
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: '${{ secrets.GITHUB_TOKEN }}'
        firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
        projectId: amplifi-a54d9
        channelId: live
      env:
        FIREBASE_CLI_EXPERIMENTS: webframeworks
    
    - name: Verify deployment
      run: |
        echo "âœ… Deployment completed successfully"
        echo "ğŸŒ Live URL: https://amplifi-a54d9.web.app"

  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Run Security Scan
      run: |
        echo "ğŸ” Running security scan..."
        
        # Check for actual secrets (not public client-side keys)
        if grep -r "sk_test_" . --exclude-dir=.git --exclude-dir=node_modules 2>/dev/null || \
           grep -r "sk_live_" . --exclude-dir=.git --exclude-dir=node_modules 2>/dev/null || \
           grep -r "firebase-adminsdk" . --exclude-dir=.git --exclude-dir=node_modules 2>/dev/null; then
          echo "âŒ Actual secrets found in repository!"
          exit 1
        else
          echo "âœ… No actual secrets found - only safe public keys detected"
        fi
    
    - name: Validate Firebase Config
      run: |
        echo "ğŸ” Validating Firebase configuration..."
        
        if [ -f "public/config/firebaseConfig.js" ]; then
          if grep -q "AIzaSy" public/config/firebaseConfig.js; then
            echo "âœ… Firebase API key found (safe public client-side key)"
          else
            echo "âŒ Firebase API key missing or incorrect"
            exit 1
          fi
        else
          echo "âŒ Firebase config file not found"
          exit 1
        fi
    
    - name: Check for sensitive files
      run: |
        echo "ğŸ” Checking for sensitive files..."
        
        # Check for common sensitive file patterns
        if find . -name "*.key" -o -name "*.pem" -o -name "serviceAccountKey.json" -o -name "firebase-adminsdk*.json" | grep -v node_modules | grep -v .git; then
          echo "âŒ Sensitive files found in repository!"
          exit 1
        else
          echo "âœ… No sensitive files found"
        fi
    
    - name: Validate HTML files
      run: |
        echo "ğŸ” Validating HTML files..."
        
        # Check if all required HTML files exist
        required_files=("index.html" "feed.html" "moments.html" "trending.html" "live.html" "upload.html" "profile.html" "library.html" "search.html")
        
        for file in "${required_files[@]}"; do
          if [ -f "public/$file" ]; then
            echo "âœ… Found: $file"
          else
            echo "âŒ Missing: $file"
            exit 1
          fi
        done
        
        echo "âœ… All required HTML files present"

  build-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        if [ -f "package.json" ]; then
          npm install
        else
          echo "No package.json found, skipping npm install"
        fi
    
    - name: Check file structure
      run: |
        echo "ğŸ” Checking project structure..."
        
        # Check essential directories
        if [ -d "public" ]; then
          echo "âœ… Public directory exists"
        else
          echo "âŒ Public directory missing"
          exit 1
        fi
        
        if [ -d "public/assets" ]; then
          echo "âœ… Assets directory exists"
        else
          echo "âŒ Assets directory missing"
          exit 1
        fi
        
        if [ -d "public/assets/css" ]; then
          echo "âœ… CSS directory exists"
        else
          echo "âŒ CSS directory missing"
          exit 1
        fi
        
        if [ -d "public/assets/js" ]; then
          echo "âœ… JavaScript directory exists"
        else
          echo "âŒ JavaScript directory missing"
          exit 1
        fi
    
    - name: Validate CSS files
      run: |
        echo "ğŸ” Validating CSS files..."
        
        if [ -f "public/assets/css/youtube-style.css" ]; then
          echo "âœ… Main CSS file found"
          # Check if CSS file has content
          if [ -s "public/assets/css/youtube-style.css" ]; then
            echo "âœ… CSS file has content"
          else
            echo "âŒ CSS file is empty"
            exit 1
          fi
        else
          echo "âŒ Main CSS file missing"
          exit 1
        fi
    
    - name: Validate JavaScript files
      run: |
        echo "ğŸ” Validating JavaScript files..."
        
        # Check for essential JS files
        js_files=("app.js" "core-features.js" "pexels-service.js" "image-loader.js")
        
        for file in "${js_files[@]}"; do
          if [ -f "public/assets/js/$file" ]; then
            echo "âœ… Found: $file"
          else
            echo "âŒ Missing: $file"
            exit 1
          fi
        done
        
        echo "âœ… All essential JavaScript files present"